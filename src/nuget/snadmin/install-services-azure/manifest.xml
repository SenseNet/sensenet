<Package type='Install'>
  <Id>SenseNet.Services</Id>
  <Description>Sense/Net ECM Services 7.0 (beta)</Description>
  <ReleaseDate>2017-04-20</ReleaseDate>
  <Version>7.0.0</Version>
  <Parameters>
    <Parameter name="@dataSource" description="Name of the database server (. or MACHINENAME\SQL2016). Default: .">.</Parameter>
    <Parameter name="@initialCatalog" description="Database name for the repository. Default: sensenet.">sensenet</Parameter>
    <Parameter name="@userName" description="User name to access the server."></Parameter>
    <Parameter name="@password" description="Password to access the server."></Parameter>
    <Parameter name="@recreateDbIfExists">false</Parameter>    
  </Parameters>
  <Steps>
    <Phase>

      <IfDatabaseExists name="@initialCatalog">
        <Then>
          <If condition="@recreateDbIfExists">
            <Then>
              <Trace>Database exists, re-creating it...</Trace>
              <Assign Name="@needToCreate">true</Assign>
            </Then>
            <Else>
              <Trace>Database exists, skipping database creation.</Trace>
              <Assign Name="@needToCreate">false</Assign>
            </Else>
          </If>
        </Then>
        <Else>
          <Assign Name="@needToCreate">true</Assign>
        </Else>
      </IfDatabaseExists>

      <If condition="@needToCreate">
        <Then>
          <IfMatch Value="@dataSource" Pattern="\w+\.database\.windows\.net">
            <Then>
              <Assign Name="@createScript">scripts\Create_SenseNet_Azure_Database.sql</Assign>
            </Then>
            <Else>
              <Assign Name="@createScript">scripts\Create_SenseNet_Database.sql</Assign>
            </Else>
          </IfMatch>
          <!-- Create a temp copy of the DB creator script and insert the db name to create. -->
          <Delete>App_Data\scripts\Create_SenseNet_Database_TEMP.sql</Delete>
          <Copy Source="@createScript"
                TargetDirectory="App_Data\scripts"
                NewName="Create_SenseNet_Database_TEMP.sql" />
          <ReplaceText Template="$(INITIALCATALOG)" Path="App_Data\scripts\Create_SenseNet_Database_TEMP.sql">@initialCatalog</ReplaceText>

          <ExecuteDatabaseScript initialCatalog="Master" DataSource="@dataSource" UserName="@userName" Password="@password" Query="..\..\..\App_Data\scripts\Create_SenseNet_Database_TEMP.sql" />
        </Then>
      </If>      
      <CheckDatabaseConnection InitialCatalogName="@initialCatalog" DataSource="@dataSource" UserName="@userName" Password="@password"/>
      <ExecuteDatabaseScript InitialCatalogName="@initialCatalog" DataSource="@dataSource" UserName="@userName" Password="@password" Query="scripts\Install_Security.sql" />
      <ExecuteDatabaseScript InitialCatalogName="@initialCatalog" DataSource="@dataSource" UserName="@userName" Password="@password" Query="scripts\Install_01_Schema.sql" />
      <ExecuteDatabaseScript InitialCatalogName="@initialCatalog" DataSource="@dataSource" UserName="@userName" Password="@password" Query="scripts\Install_02_Procs.sql" />
      <ExecuteDatabaseScript InitialCatalogName="@initialCatalog" DataSource="@dataSource" UserName="@userName" Password="@password" Query="scripts\Install_03_Data_Phase1.sql" />
      <ExecuteDatabaseScript InitialCatalogName="@initialCatalog" DataSource="@dataSource" UserName="@userName" Password="@password" Query="scripts\Install_04_Data_Phase2.sql" />

      <!-- Insert new connection string values into config files. -->
      <EditConnectionString ConnectionName="SnCrMsSql" InitialCatalogName="@initialCatalog" DataSource="@dataSource" File="Web.config" />
      <ForEach item="@configPath" files="Tools\*.config">
        <Block>
          <EditConnectionString ConnectionName="SnCrMsSql" InitialCatalogName="@initialCatalog" DataSource="@dataSource" File="@configPath" />
        </Block>
      </ForEach>
      
      <!-- Cleanup -->
      <Delete>App_Data\scripts\Create_SenseNet_Database_TEMP.sql</Delete>
    </Phase>
    <Phase>
      <StartRepository startLuceneManager="false" startWorkflowEngine="false" />
      <Import target="/Root" resetSecurity="true" LogLevel="Verbose" source="import" />
    </Phase>
    <Phase>
      <StartRepository startLuceneManager="false" startWorkflowEngine="false" />
      <PopulateIndex />
    </Phase>
  </Steps>
</Package>